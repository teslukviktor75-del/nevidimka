
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nevidimka ‚Äî Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0a0f1f; --card:#0f1833; --text:#eaf0ff; --muted:#9fb0e6;
      --line:rgba(255,255,255,.08); --accent:#5b7cff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
    header{padding:14px 14px 10px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(10,15,31,.9);backdrop-filter:blur(10px)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .wrap{max-width:920px;margin:0 auto;padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{border:1px solid var(--line);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .tab.active{background:var(--card);border-color:rgba(91,124,255,.5)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin-bottom:12px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b132b;color:var(--text);outline:none}
    textarea{min-height:100px;resize:vertical}
    .btn{background:var(--accent);border:none;color:white;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid var(--line);color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .msg{padding:10px;border:1px solid var(--line);border-radius:14px;background:#0b132b}
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-bottom:6px}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .split > *{flex:1;min-width:220px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <div style="font-weight:800;font-size:16px">nevidimka</div>
      <div class="small" id="who">Mini App</div>
    </div>
    <div class="pill" id="env">Telegram</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="chat">üí¨ –ß–∞—Ç</button>
    <button class="tab" data-tab="posts">üìù –ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó</button>
    <button class="tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</button>
    <button class="tab" data-tab="data">üóÇ –ê—Ä—Ö—ñ–≤</button>
  </div>
</header>

<div class="wrap">
  <!-- CHAT -->
  <section id="tab-chat" class="card">
    <div class="row">
      <div style="font-weight:700">–ß–∞—Ç</div>
      <button class="btn secondary" id="clearChat">–û—á–∏—Å—Ç–∏—Ç–∏</button>
    </div>

    <label>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
    <input id="chatInput" placeholder="–ù–∞–ø–∏—à–∏ —â–æ—Å—å..." />

    <div style="height:10px"></div>
    <button class="btn" id="sendChat">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>

    <div style="height:14px"></div>
    <div class="grid" id="chatList"></div>
  </section>

  <!-- POSTS -->
  <section id="tab-posts" class="card" style="display:none">
    <div style="font-weight:700;margin-bottom:8px">–ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó</div>

    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input id="postTitle" placeholder="–ù–∞–ø—Ä: –ù–æ–≤–∏–π –ø–æ—Å—Ç" />

    <label>–¢–µ–∫—Å—Ç</label>
    <textarea id="postText" placeholder="–¢–≤—ñ–π —Ç–µ–∫—Å—Ç..."></textarea>

    <label>–§–æ—Ç–æ (–∑ –≥–∞–ª–µ—Ä–µ—ó)</label>
    <input type="file" id="postImage" accept="image/*" />

    <div style="height:10px"></div>
    <button class="btn" id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>

    <div style="height:14px"></div>
    <div class="grid" id="postList"></div>
  </section>

  <!-- PROFILE -->
  <section id="tab-profile" class="card" style="display:none">
    <div style="font-weight:700;margin-bottom:8px">–ü—Ä–æ—Ñ—ñ–ª—å</div>

    <div class="split">
      <div>
        <label>–ù—ñ–∫</label>
        <input id="nick" placeholder="nevidimka" />

        <label>–ü—Ä–æ —Å–µ–±–µ</label>
        <textarea id="bio" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ —Å–µ–±–µ..."></textarea>

        <button class="btn" id="saveProfile">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>

      <div>
        <label>–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é</label>
        <input type="file" id="avatar" accept="image/*" />
        <div style="height:10px"></div>
        <img id="avatarPreview" alt="" style="width:100%;max-width:280px;border-radius:16px;border:1px solid var(--line);display:none" />
        <div class="small" style="margin-top:8px">–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–≤ Mini App).</div>
      </div>
    </div>
  </section>

  <!-- DATA / EXPORT -->
  <section id="tab-data" class="card" style="display:none">
    <div style="font-weight:700;margin-bottom:8px">–ê—Ä—Ö—ñ–≤ –¥–∞–Ω–∏—Ö</div>
    <div class="small">–ï–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç JSON (—Ä–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è).</div>

    <div style="height:10px"></div>
    <button class="btn secondary" id="exportBtn">–ï–∫—Å–ø–æ—Ä—Ç</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" />
    <button class="btn" id="importBtn">–Ü–º–ø–æ—Ä—Ç</button>

    <div style="height:12px"></div>
    <label>JSON</label>
    <textarea id="jsonBox" placeholder="–¢—É—Ç –∑ º—è–≤–∏—Ç—å—Å—è –µ–∫—Å–ø–æ—Ä—Ç..."></textarea>
  </section>
</div>

<script>
  // Telegram init
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    document.getElementById("env").textContent = "Telegram Mini App";
    const u = tg.initDataUnsafe?.user;
    if (u) {
      document.getElementById("who").textContent = `@${u.username || "user"} ‚Ä¢ id:${u.id}`;
    }
  } else {
    document.getElementById("env").textContent = "Browser preview";
  }

  // Simple storage
  const SKEY = "nevidimka_miniapp_v1";
  const state = load() || { chat: [], posts: [], profile: { nick:"nevidimka", bio:"", avatarDataUrl:"" } };

  function load(){ try { return JSON.parse(localStorage.getItem(SKEY)); } catch(e){ return null; } }
  function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

  // Tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["chat","posts","profile","data"].forEach(t=>{
        document.getElementById("tab-"+t).style.display = (t===tab) ? "block" : "none";
      });
    });
  });

  // Chat
  const chatInput = document.getElementById("chatInput");
  const chatList  = document.getElementById("chatList");

  function renderChat(){
    chatList.innerHTML = "";
    state.chat.slice().reverse().forEach(m=>{
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `
        <div class="meta"><span>${escapeHtml(m.author)}</span><span>‚Ä¢</span><span>${new Date(m.ts).toLocaleString()}</span></div>
        <div>${escapeHtml(m.text)}</div>
      `;
      chatList.appendChild(div);
    });
  }

  document.getElementById("sendChat").addEventListener("click", ()=>{
    const text = chatInput.value.trim();
    if(!text) return;
    const author = state.profile.nick || "nevidimka";
    state.chat.push({ author, text, ts: Date.now() });
    chatInput.value = "";
    save(); renderChat();
    if (tg) tg.HapticFeedback?.impactOccurred("light");
  });

  document.getElementById("clearChat").addEventListener("click", ()=>{
    state.chat = [];
    save(); renderChat();
  });

  // Posts
  const postList = document.getElementById("postList");
  function renderPosts(){
    postList.innerHTML = "";
    state.posts.slice().reverse().forEach(p=>{
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `
        <div class="meta"><span>${escapeHtml(p.author)}</span><span>‚Ä¢</span><span>${new Date(p.ts).toLocaleString()}</span></div>
        <div style="font-weight:700;margin-bottom:6px">${escapeHtml(p.title)}</div>
        <div style="white-space:pre-wrap">${escapeHtml(p.text)}</div>
        ${p.image ? `<div style="height:10px"></div><img src="${p.image}" style="width:100%;border-radius:14px;border:1px solid var(--line)" />` : ""}
      `;
      postList.appendChild(div);
    });
  }

  document.getElementById("addPost").addEventListener("click", async ()=>{
    const title = document.getElementById("postTitle").value.trim();
    const text  = document.getElementById("postText").value.trim();
    const file  = document.getElementById("postImage").files[0];
    if(!title && !text && !file) return;

    const image = file ? await fileToDataUrl(file) : "";
    state.posts.push({
      author: state.profile.nick || "nevidimka",
      title: title || "–ë–µ–∑ –Ω–∞–∑–≤–∏",
      text: text || "",
      image,
      ts: Date.now()
    });

    document.getElementById("postTitle").value = "";
    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";

    save(); renderPosts();
  });

  // Profile
  const avatarPreview = document.getElementById("avatarPreview");

  function renderProfile(){
    document.getElementById("nick").value = state.profile.nick || "nevidimka";
    document.getElementById("bio").value  = state.profile.bio || "";
    if (state.profile.avatarDataUrl){
      avatarPreview.src = state.profile.avatarDataUrl;
      avatarPreview.style.display = "block";
    } else {
      avatarPreview.style.display = "none";
    }
  }

  document.getElementById("saveProfile").addEventListener("click", ()=>{
    state.profile.nick = document.getElementById("nick").value.trim() || "nevidimka";
    state.profile.bio  = document.getElementById("bio").value.trim();
    save();
    if (tg) tg.showPopup?.({ title:"–ó–±–µ—Ä–µ–∂–µ–Ω–æ", message:"–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ", buttons:[{type:"ok"}] });
  });

  document.getElementById("avatar").addEventListener("change", async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    state.profile.avatarDataUrl = await fileToDataUrl(f);
    save();
    renderProfile();
  });

  // Export / Import
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    document.getElementById("jsonBox").value = JSON.stringify(state, null, 2);
  });

  const importFile = document.getElementById("importFile");
  document.getElementById("importBtn").addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", async ()=>{
    const f = importFile.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("bad");
      localStorage.setItem(SKEY, JSON.stringify(obj));
      location.reload();
    }catch(e){
      alert("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É JSON");
    }
  });

  // helpers
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fileToDataUrl(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // initial render
  renderProfile();
  renderChat();
  renderPosts();
</script>
</body>
</html>